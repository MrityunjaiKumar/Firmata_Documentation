<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Firmata library reference: SPI (Proposal)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="firmata-docs.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Firmata library reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__g_1__arduino-workspace__firmata_protocol_proposals_spi-proposal.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">SPI (Proposal) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A proposal for a SPI protocol for Firmata.</p>
<p>SPI is tricky to add to Firmata in a generic way since it is a fairly loose standard. There are variations in number of bits written and read, how the CS pin is used (if at all), use of other pins, etc. This proposal attempts to accommodate uses cases beyond the common sequence of:</p>
<ol type="1">
<li>set cs pin LOW</li>
<li>write/read 1 or more words</li>
<li>set cs Pin HIGH</li>
<li>return data read</li>
</ol>
<h2><a class="anchor" id="autotoc_md79"></a>
Overview</h2>
<p>A <code>SPI_BEGIN</code> command is used to initialize the SPI bus. Up to 8 SPI ports are supported using the <code>channel</code> parameter.</p>
<p>The <code>SPI_DEVICE_CONFIG</code> command is used to configure each attached SPI device.</p>
<p>There are 3 ways to send and receive data from the SPI slave device:</p>
<ol type="1">
<li><code>SPI_TRANSFER</code> For each word written a word is read simultaneously.</li>
<li><code>SPI_WRITE</code> Only write data (ignore any data returned by the slave device).</li>
<li><code>SPI_READ</code> Only read data, writing <code>0</code> for each word to be read.</li>
</ol>
<p>A <code>SPI_REPLY</code> is used to send requested data back to the client application when either a <code>SPI_TRANSFER</code> mode or <code>SPI_READ</code> command is sent.</p>
<p>A <code>SPI_END</code> command disables the SPI bus for the specified channel.</p>
<h2><a class="anchor" id="autotoc_md80"></a>
SPI_BEGIN</h2>
<p>Required for platforms that require SPI bus initialization, such as Arduino. Optional if initialization is automatic (some Linux-based platforms for example).</p>
<p>Use <code>SPI_BEGIN</code> to initialize the SPI bus. Up to 8 SPI ports are supported, where each port is identified by a <code>channel</code> number (0-7).</p>
<p><code>SPI_BEGIN</code> must be called at least once before sending any of the other commands.</p>
<p><code>channel</code> is used to identify which SPI bus is used in the case that a board has multiple ports (SPI, SPI1, SPI2, etc). Many boards only have one port so the <code>channel</code> value will most often be <code>0</code>.</p>
<div class="fragment"><div class="line">0:  START_SYSEX</div>
<div class="line">1:  SPI_DATA              (0x68)</div>
<div class="line">2:  SPI_BEGIN             (0x00)</div>
<div class="line">3:  channel               (HW supports multiple SPI ports. range = 0-7, default = 0)</div>
<div class="line">4:  END_SYSEX</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md81"></a>
SPI_DEVICE_CONFIG</h2>
<p>Send this command once for each attached SPI device to initialize it before use. See parameter descriptions below.</p>
<div class="fragment"><div class="line">0:  START_SYSEX</div>
<div class="line">1:  SPI_DATA              (0x68)</div>
<div class="line">2:  SPI_DEVICE_CONFIG     (0x01)</div>
<div class="line">3:  deviceId | channel    (bits 3-6: deviceId, bits 0-2: channel)</div>
<div class="line">4:  dataMode | bitOrder   (bits 1-2: dataMode (0-3), bit 0: bitOrder)</div>
<div class="line">5:  maxSpeed              (bits 0 - 6)</div>
<div class="line">6:  maxSpeed              (bits 7 - 14)</div>
<div class="line">7:  maxSpeed              (bits 15 - 21)</div>
<div class="line">8:  maxSpeed              (bits 22 - 28)</div>
<div class="line">9:  maxSpeed              (bits 29 - 32)</div>
<div class="line">10: wordSize              (0 = DEFAULT = 8-bits, 1 = 1-bit, 2 = 2 bits, etc)</div>
<div class="line">11: csPinOptions          bit 0: CS_PIN_CONTROL (0 = disable</div>
<div class="line">                                                 1 = enable (default))</div>
<div class="line">                          bit 1: CS_ACTIVE_STATE (0 = Active LOW (default)</div>
<div class="line">                                                  1 = Active HIGH)</div>
<div class="line">                          bits 2-6: reserved for future options</div>
<div class="line">12: csPin                 (0-127) The chip select pin number (ignored if</div>
<div class="line">                          CS_PIN_CONTROL set to 0)</div>
<div class="line">13: END_SYSEX</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md82"></a>
deviceId</h3>
<p>The <code>deviceId</code> may either be used as a specific identifier (Linux) or as an arbitrary identifier (Arduino). The <code>deviceId</code> value range is from 0 to 15 and can be specified separately for each SPI channel. The <code>deviceId</code> will also be returned with the channel for each <code>SPI_REPLY</code> command so it is clear which device the data corresponds to.</p>
<h3><a class="anchor" id="autotoc_md83"></a>
bitOrder</h3>
<div class="fragment"><div class="line">LSBFIRST = 0</div>
<div class="line">MSBFIRST = 1 (default)</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md84"></a>
dataMode</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">mode  </th><th class="markdownTableHeadNone">clock polarity (CPOL)  </th><th class="markdownTableHeadNone">clock phase (CPHA)   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">0   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">0  </td><td class="markdownTableBodyNone">1   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">0   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">3  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">1   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md85"></a>
maxSpeed</h3>
<p>The maximum speed of communication with the SPI device. For a SPI device rated up to 5 MHz, use 5000000.</p>
<p><em>For platforms that use a clock divider instead of a speed, pass the clock divider value instead.</em></p>
<h3><a class="anchor" id="autotoc_md86"></a>
wordSize</h3>
<p>The size of a <code>word</code> in bits. Typically 8-bits (default). 0 = DEFAULT = 8-bits, 1 = 1 bit, 2 = 2 bits, etc (limit is TBD).</p>
<h3><a class="anchor" id="autotoc_md87"></a>
csPinOptions / csPin</h3>
<p>Use <code>CS_ACTIVE_STATE</code> to set the active state (typically LOW) for the CS pin. If the platform's SPI implementation does not already automatically handle the CS pin (it's handled automatically on Raspberry Pi, but not Arduino boards for example), then set <code>CS_PIN_CONTROL</code> to <code>enable</code> and specify the <code>csPin</code> number in byte 12. If the platform already handles the csPin then set <code>CS_PIN_CONTROL</code> to <code>disable</code> and the <code>csPin</code> number will be ignored (set to zero). For non-Linux platforms such as Arduino, to enable manual control of the CS pin using <code>DIGITAL_MESSAGE</code> commands, set <code>CS_PIN_CONTROL</code> to <code>disable</code>.</p>
<h2><a class="anchor" id="autotoc_md88"></a>
SPI_TRANSFER</h2>
<p>Full-duplex write/read transfer. This is the normal SPI transfer mode, a word must be written for every word read. Reply is sent via <code>SPI_REPLY</code>.</p>
<p>Since transport (Serial, Ethernet, Wi-Fi, etc) buffers tend to be small on microcontroller platforms, it may be necessary to send several <code>SPI_TRANSFER</code> commmands to complete a single SPI transaction. Use the <code>deselectCsPin</code> parameter to ensure the CS pin is not deselected in between <code>SPI_TRANSFER</code> commands until the transaction is complete.</p>
<p><code>requestId</code> is used in the request messages <code>SPI_TRANSFER</code>, <code>SPI_WRITE</code> and <code>SPI_READ</code> and in the reply message <code>SPI_REPLY</code>. Its purpose is to ensure that the SPI_REPLY message matches the request. For each request message, increment a single 7-bit requestId value, rolling it over to 0 when &gt; 127.</p>
<p><code>deselectCsPin</code> is used to control the csPin at the end of the transfer. By default the csPin will be deselected at the end of every transfer. However, to prevent deselection to enable back-to-back transfers for example, set <code>deselectCsPin</code> to <code>0</code> and the pin state won't be affected at the end of the transfer.</p>
<p>If <code>CS_PIN_CONTROL</code> is enabled, then the CS pin active state will be set when the <code>SPI_TRANSFER</code> command is received. It will only be deselected at the end of the transfer if <code>deselectCsPin</code> is set to 1.</p>
<div class="fragment"><div class="line">0:  START_SYSEX</div>
<div class="line">1:  SPI_DATA              (0x68)</div>
<div class="line">2:  SPI_TRANSFER          (0x02)</div>
<div class="line">3:  deviceId | channel    (bits 3-6: deviceId, bits 0-2: channel)</div>
<div class="line">4:  requestId             (0-127) // increment for each call</div>
<div class="line">5:  deselectCsPin         (0 = don&#39;t deselect csPin</div>
<div class="line">                          1 = deselect csPin (default))</div>
<div class="line">6.  numWords              (0-127: number of words to transfer)</div>
<div class="line">7:  data 0                (bits 0-6)</div>
<div class="line">8:  data 0                (bits 7-14 if word size if word size &gt; 7 &amp;&amp; &lt; 15)</div>
<div class="line">9:  data 0                (if word size &gt; 14)</div>
<div class="line">...                       up to numWords * (wordSize / 7)</div>
<div class="line">N:  END_SYSEX</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md89"></a>
SPI_WRITE</h2>
<p>Only write data, ignoring any data returned by the slave device.</p>
<p>Provided as a convenience. The same can be accomplished using <code>SPI_TRANSFER</code> and ignoring the <code>SPI_REPLY</code> command.</p>
<p>If <code>CS_PIN_CONTROL</code> is enabled, then the CS pin active state will be set when the <code>SPI_WRITE</code> command is received. It will only be deselected at the end of the write if <code>deselectCsPin</code> is set to 1.</p>
<p>A <code>SPI_WRITE</code> command should return a <code>SPI_REPLY</code> with a value of <code>1</code> if the write was successful or a value of <code>0</code> if the write failed.</p>
<div class="fragment"><div class="line">0:  START_SYSEX</div>
<div class="line">1:  SPI_DATA              (0x68)</div>
<div class="line">2:  SPI_WRITE             (0x03)</div>
<div class="line">3:  deviceId | channel    (bits 3-6: deviceId, bits 0-2: channel)</div>
<div class="line">4:  requestId             (0-127) // increment for each call</div>
<div class="line">5:  deselectCsPin         (0 = don&#39;t deselect csPin</div>
<div class="line">                          1 = deselect csPin (default))</div>
<div class="line">6.  numWords              (0-127: number of words to write)</div>
<div class="line">7:  data 0                (bits 0-6)</div>
<div class="line">8:  data 0                (bits 7-14 if word size if word size &gt; 7 &amp;&amp; &lt; 15)</div>
<div class="line">9:  data 0                (if word size &gt; 14)</div>
<div class="line">...                       up to numWords * (wordSize / 7)</div>
<div class="line">N:  END_SYSEX</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md90"></a>
SPI_READ</h2>
<p>Only read data, writing <code>0</code> for each word to be read. Reply is sent via <code>SPI_REPLY</code>.</p>
<p>Provided as a convenience. The same can be accomplished using <code>SPI_TRANSFER</code> and sending a <code>0</code> for each byte to be read.</p>
<p>If <code>CS_PIN_CONTROL</code> is enabled, then the CS pin active state will be set when the <code>SPI_READ</code> command is received. It will only be deselected at the end of the read if <code>deselectCsPin</code> is set to 1.</p>
<div class="fragment"><div class="line">0:  START_SYSEX</div>
<div class="line">1:  SPI_DATA              (0x68)</div>
<div class="line">2:  SPI_WRITE             (0x04)</div>
<div class="line">3:  deviceId | channel    (bits 3-6: deviceId, bits 0-2: channel)</div>
<div class="line">4:  requestId             (0-127)  // increment for each call</div>
<div class="line">5:  deselectCsPin         (0 = don&#39;t deselect csPin</div>
<div class="line">                          1 = deselect csPin (default))</div>
<div class="line">6.  numWords              (0-127: number of words to read)</div>
<div class="line">7:  END_SYSEX</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md91"></a>
SPI_REPLY</h2>
<p>An array of data received from the SPI slave device in response to a <code>SPI_TRANSFER</code> or <code>SPI_READ</code> command. The <code>requestId</code> should match the ID from the transfer, read or write command.</p>
<div class="fragment"><div class="line">0:  START_SYSEX</div>
<div class="line">1:  SPI_DATA              (0x68)</div>
<div class="line">2:  SPI_REPLY             (0x05)</div>
<div class="line">3:  deviceId | channel    (bits 3-6: deviceId, bits 0-2: channel)</div>
<div class="line">4:  requestId             (0-127) // must match the ID from the request</div>
<div class="line">5:  numWords              (0-127: number of words in the reply)</div>
<div class="line">6:  data 0                (bits 0-6)</div>
<div class="line">7:  data 0                (bits 7-14 if word size if word size &gt; 7 &amp;&amp; &lt; 15)</div>
<div class="line">8:  data 0                (if word size &gt; 14)</div>
<div class="line">...                       up to numWords * (wordSize / 7)</div>
<div class="line">N:  END_SYSEX</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md92"></a>
SPI_END</h2>
<p>Call to release SPI hardware send before quitting a Firmata client application.</p>
<div class="fragment"><div class="line">0:  START_SYSEX</div>
<div class="line">1:  SPI_DATA              (0x68)</div>
<div class="line">2:  SPI_END               (0x06)</div>
<div class="line">3:  channel               (HW supports multiple SPI ports. range = 0-7, default = 0)</div>
<div class="line">4:  END_SYSEX</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
